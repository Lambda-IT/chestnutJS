<div class="model-container">
    <mat-form-field>
        <mat-select placeholder="Visible columns" [formControl]="selectedColumnsForm" multiple>
            <mat-option *ngFor="let col of availableColumns" [value]="col">{{ col }}</mat-option>
        </mat-select>
    </mat-form-field>

    <mat-expansion-panel class="filter-panel" [expanded]="expandPanel()">
        <mat-expansion-panel-header>
            <mat-panel-title>
                Add New Filter
            </mat-panel-title>
        </mat-expansion-panel-header>

        <form [formGroup]="filterForm" class="filter-form">
            <mat-form-field class="filter-field-30 ">
                <mat-select placeholder="Field" formControlName="field">
                    <mat-option *ngFor="let col of filterMetadata" [value]="col">{{ col.name }} </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field class="filter-field-10 ">
                <mat-select placeholder="Operator" formControlName="operator">
                    <mat-option value="is">is</mat-option>
                    <mat-option value="contains">contains</mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field *ifSome="(filterChange$ | async); let filterChange" class="filter-field-30 ">
                <input *ngIf="filterChange.isString" matInput placeholder="Value" formControlName="value" />
                <mat-select *ngIf="!filterChange.isString" placeholder="Value" formControlName="value">
                    <mat-option *ngFor="let value of filterChange.values" [value]="value">{{ value }}</mat-option>
                </mat-select>
            </mat-form-field>
            <button mat-raised-button (click)="applyFilter$.emit(true)" class="button">Apply Filter</button>
        </form>
        <ng-container *ifSome="filterItems$; let filterItems">
            <table mat-table [dataSource]="filterItems" class="model-table">
                <ng-container matColumnDef="field">
                    <th mat-header-cell *matHeaderCellDef>Field</th>
                    <td mat-cell *matCellDef="let filter">{{ filter.field }}</td>
                </ng-container>
                <ng-container matColumnDef="operator">
                    <th mat-header-cell *matHeaderCellDef>Operator</th>
                    <td mat-cell *matCellDef="let filter">{{ filter.operator }}</td>
                </ng-container>
                <ng-container matColumnDef="value">
                    <th mat-header-cell *matHeaderCellDef>Value</th>
                    <td mat-cell *matCellDef="let filter">{{ filter.value }}</td>
                </ng-container>
                <ng-container matColumnDef="remove">
                    <th mat-header-cell *matHeaderCellDef>Remove</th>
                    <td mat-cell *matCellDef="let filter">
                        <button mat-raised-button (click)="removeFilter.emit(filter)">Delete</button>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
                <tr mat-row *matRowDef="let myRowData; columns: columnsToDisplay"></tr>
            </table>
        </ng-container>
    </mat-expansion-panel>
    <ng-container *ngIf="(selectedColumns$ | async); let selectedColumns">
        <table *ngIf="dataSource.length > 0" mat-table [dataSource]="dataSource" class="mat-elevation-z8 model-table">
            <ng-container *ngFor="let col of selectedColumns; let i = index" matColumnDef="{{ col }}">
                <th mat-header-cell *matHeaderCellDef>{{ col }}</th>
                <ng-container *ngIf="col !== '_id'; else id">
                    <!--TODO: decide by ref col !!!!-->
                    <td mat-cell *matCellDef="let element">{{ element[col] }}</td>
                </ng-container>
                <ng-template #id>
                    <td mat-cell *matCellDef="let element">
                        <a [routerLink]="[element[col]]">{{ element[col] }}</a>
                    </td>
                </ng-template>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="selectedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: selectedColumns"></tr>
        </table>

        <ng-container *ngIf="dataSource.length === 0">
            No data found
        </ng-container>
    </ng-container>
</div>
